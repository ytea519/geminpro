<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banana Pro AI</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* é¡¶éƒ¨å›ºå®šå¸ƒå±€æ ·å¼ */
        .input-section {
            position: fixed !important;
            top: 0 !important;
            bottom: auto !important;
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
            width: 100% !important;
            max-width: 100% !important;
            border-radius: 0 !important;
            z-index: 1000 !important;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3) !important;
        }
        
        header {
            margin-top: 80px; /* ä¸ºè¾“å…¥åŒºç•™ç©ºé—´ */
        }
        
        .history-container {
            padding-bottom: 20px !important;
        }
        
        /* è°ƒæ•´è¾“å…¥åŒºå†…éƒ¨å¸ƒå±€ */
        .control-bar {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px 20px !important;
        }
        
        .preview-bar {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .preview-bar.visible {
            padding: 12px 20px;
        }
        
        /* åŠ¨æ€è°ƒæ•´headeré—´è· */
        .has-preview header {
            margin-top: 180px;
        }
        
        @media (max-width: 768px) {
            header {
                margin-top: 70px;
            }
            .has-preview header {
                margin-top: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- åœ¨é¢„è§ˆæ æ˜¾ç¤ºæ—¶æ·»åŠ  has-preview ç±» -->
    <script>
        // ç›‘å¬é¢„è§ˆæ å˜åŒ–
        const observePreviewBar = () => {
            const previewBar = document.getElementById('preview-bar');
            const observer = new MutationObserver(() => {
                if (previewBar.classList.contains('visible')) {
                    document.body.classList.add('has-preview');
                } else {
                    document.body.classList.remove('has-preview');
                }
            });
            observer.observe(previewBar, { attributes: true, attributeFilter: ['class'] });
        };
        document.addEventListener('DOMContentLoaded', observePreviewBar);
    </script>
    
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-overlay">
        <div class="login-card glass-panel">
            <h1 style="font-size: 2rem;">ğŸŒ</h1>
            <h3 style="margin: 10px 0; color: #cbd5e1;">Banana Pro</h3>
            <input type="password" id="pwd" placeholder="Password" onkeypress="if(event.key==='Enter')doLogin()">
            <button class="btn-3d" onclick="doLogin()" style="width: 100%; padding: 10px;">Unlock</button>
        </div>
    </div>
    
    <!-- ä¸»åº”ç”¨ -->
    <div class="app-container" id="app" style="filter: blur(10px); pointer-events: none;">
        <!-- é¡¶éƒ¨å›ºå®šè¾“å…¥åŒº -->
        <div class="input-section glass-panel" id="drop-zone">
            <!-- ä¸Šéƒ¨åˆ†ï¼šé¢„è§ˆæ¡ -->
            <div class="preview-bar" id="preview-bar"></div>
            
            <!-- ä¸‹éƒ¨åˆ†ï¼šæ“ä½œæ  -->
            <div class="control-bar">
                <button class="upload-trigger" id="upload-btn" title="ä¸Šä¼ å‚è€ƒå›¾">ğŸ“·</button>
                <textarea id="prompt" class="main-input" rows="1" placeholder="æè¿°ç”»é¢... (æ”¯æŒæ‹–æ‹½å›¾ç‰‡)"></textarea>
                <button class="btn-3d send-btn" id="send-btn">
                    <span>ç”Ÿæˆ</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
        
        <header>
            <div>
                <h2>åˆ›æ„ç”»æ¿</h2>
                <div style="font-size: 12px; color: var(--text-sub);" id="status-bar">Ready</div>
            </div>
        </header>
        
        <!-- å†å²ç”»å»Š -->
        <div class="history-container">
            <div class="grid-layout" id="gallery"></div>

            <section class="public-gallery-section glass-panel">
                <div class="section-title">
                    <div>
                        <h3>å…¬å…±ç”»å»Š</h3>
                        <p class="section-subtitle" id="public-gallery-hint">åˆ†äº«ä½ çš„ä½œå“ï¼Œæ¬£èµç¤¾åŒºçµæ„Ÿ</p>
                    </div>
                    <div class="section-actions">
                        <button class="icon-btn" id="refresh-public-gallery" title="åˆ·æ–°å…¬å…±ç”»å»Š" aria-label="åˆ·æ–°å…¬å…±ç”»å»Š">âŸ³</button>
                    </div>
                </div>
                <div class="grid-layout public-grid" id="public-gallery"></div>
            </section>
        </div>

        <input type="file" id="file-input" multiple accept="image/*" hidden>
    </div>
    
    <!-- è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="modal">
        <div class="modal-content glass-panel">
            <button class="close-modal" onclick="closeModal()">Ã—</button>
            <div class="modal-img-area">
                <img id="m-img" src="">
            </div>
            <div class="modal-footer">
                <div class="input-refs" id="m-refs"></div>
                <div class="prompt-display" id="m-prompt"></div>
                <button class="btn-3d" id="m-reuse" style="width: 100%; padding: 12px;">
                    ğŸ¨ å¤ç”¨å‚æ•°ä¸å›¾ç‰‡
                </button>
            </div>
        </div>
    </div>
    
    <script>
    // ============================================
    // å…¨å±€çŠ¶æ€ç®¡ç†
    // ============================================
    const AppState = {
        db: null,
        currentImages: [],     // å½“å‰ä¸Šä¼ çš„å›¾ç‰‡ Base64 æ•°ç»„
        galleryData: [],       // ä¸ªäººç”»å»Šæ•°æ®ç¼“å­˜
        publicGalleryData: [], // å…¬å…±ç”»å»Šæ•°æ®ç¼“å­˜
        currentModalItem: null // å½“å‰å¼¹çª—æ˜¾ç¤ºçš„é¡¹ç›®
    };

    const STORAGE_KEYS = {
        publicGalleryTokens: 'BananaPro_PublicGallery_Tokens_v1'
    };

    const DEFAULT_PUBLIC_HINT = 'åˆ†äº«ä½ çš„ä½œå“ï¼Œæ¬£èµç¤¾åŒºçµæ„Ÿ';

    const DB_NAME = 'BananaProDB_v3';

    const STORE_NAME = 'artworks';
    
    // ============================================
    // IndexedDB æ¨¡å—ï¼ˆä½¿ç”¨ Blob å­˜å‚¨é¿å… Base64 é—®é¢˜ï¼‰
    // ============================================
    const Database = {
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                
                request.onsuccess = () => {
                    AppState.db = request.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        },
        
        async save(item) {
            return new Promise((resolve, reject) => {
                const tx = AppState.db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                
                // ç›´æ¥å­˜å‚¨å®Œæ•´å¯¹è±¡ï¼Œä¸åšä»»ä½•è½¬æ¢
                const record = {
                    prompt: item.prompt,
                    image: item.image,           // å®Œæ•´çš„ data:image/... å­—ç¬¦ä¸²
                    inputImages: item.inputImages || [],
                    timestamp: Date.now()
                };
                
                const request = store.add(record);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        
        async getAll() {
            return new Promise((resolve, reject) => {
                const tx = AppState.db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    // æŒ‰æ—¶é—´æˆ³å€’åº
                    const results = request.result.sort((a, b) => b.timestamp - a.timestamp);
                    resolve(results);
                };
                request.onerror = () => reject(request.error);
            });
        },
        
        async delete(id) {
            return new Promise((resolve, reject) => {
                const tx = AppState.db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        },
        
        async getById(id) {
            return new Promise((resolve, reject) => {
                const tx = AppState.db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
    };
    
    // ============================================
    // å›¾ç‰‡å¤„ç†æ¨¡å—
    // ============================================
    const ImageHandler = {
        // æ–‡ä»¶è½¬ Base64
        fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        },
        
        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        async processFiles(files) {
            const maxImages = 16;
            const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            
            for (const file of imageFiles) {
                if (AppState.currentImages.length >= maxImages) {
                    alert(`æœ€å¤šåªèƒ½ä¸Šä¼  ${maxImages} å¼ å›¾ç‰‡`);
                    break;
                }
                
                try {
                    const base64 = await this.fileToBase64(file);
                    AppState.currentImages.push(base64);
                } catch (err) {
                    console.error('å›¾ç‰‡è¯»å–å¤±è´¥:', err);
                }
            }
            
            PreviewManager.render();
        },
        
        // ç§»é™¤æŒ‡å®šç´¢å¼•çš„å›¾ç‰‡
        removeAt(index) {
            AppState.currentImages.splice(index, 1);
            PreviewManager.render();
        },
        
        // æ¸…ç©ºæ‰€æœ‰ä¸Šä¼ çš„å›¾ç‰‡
        clear() {
            AppState.currentImages = [];
            PreviewManager.render();
        },
        
        // è®¾ç½®å›¾ç‰‡ï¼ˆç”¨äºå¤ç”¨åŠŸèƒ½ï¼‰
        setImages(images) {
            AppState.currentImages = images ? [...images] : [];
            PreviewManager.render();
        }
    };
    
    // ============================================
    // é¢„è§ˆæ¡ç®¡ç†æ¨¡å—
    // ============================================
    const PreviewManager = {
        container: null,
        uploadBtn: null,
        statusBar: null,
        
        init() {
            this.container = document.getElementById('preview-bar');
            this.uploadBtn = document.getElementById('upload-btn');
            this.statusBar = document.getElementById('status-bar');
        },
        
        render() {
            // æ¸…ç©ºå®¹å™¨
            this.container.innerHTML = '';
            
            const images = AppState.currentImages;
            
            if (images.length === 0) {
                this.container.classList.remove('visible');
                this.uploadBtn.classList.remove('active');
                this.statusBar.textContent = 'Ready';
                return;
            }
            
            this.container.classList.add('visible');
            this.uploadBtn.classList.add('active');
            this.statusBar.textContent = `å·²é€‰æ‹© ${images.length}/16 å¼ å›¾ç‰‡`;
            
            // ä½¿ç”¨ DOM API åˆ›å»ºå…ƒç´ ï¼Œé¿å… innerHTML å¯¼è‡´çš„ç¼–ç é—®é¢˜
            images.forEach((imgData, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'thumb-wrapper';
                
                const img = document.createElement('img');
                img.src = imgData;  // ç›´æ¥è®¾ç½® srcï¼Œä¸ç»è¿‡å­—ç¬¦ä¸²æ‹¼æ¥
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'thumb-remove';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    ImageHandler.removeAt(index);
                };
                
                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                this.container.appendChild(wrapper);
            });
        }
    };
    
    // ============================================
    // ç”»å»Šç®¡ç†æ¨¡å—
    // ============================================
    const GalleryManager = {
        container: null,
        
        init() {
            this.container = document.getElementById('gallery');
        },
        
        async load() {
            try {
                AppState.galleryData = await Database.getAll();
                this.render();
            } catch (err) {
                console.error('åŠ è½½ç”»å»Šå¤±è´¥:', err);
            }
        },
        
        render() {
            this.container.innerHTML = '';
            
            if (AppState.galleryData.length === 0) {
                this.container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: var(--text-sub); padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¨</div>
                        <div>æš‚æ— ä½œå“ï¼Œå¼€å§‹åˆ›ä½œå§ï¼</div>
                    </div>
                `;
                return;
            }
            
            AppState.galleryData.forEach(item => {
                const card = this.createCard(item);
                this.container.appendChild(card);
            });
        },
        
        createCard(item) {
            const el = document.createElement('div');
            el.className = 'history-item';
            el.dataset.id = item.id;
            
            // å‚è€ƒå›¾æ ‡è®°
            if (item.inputImages && item.inputImages.length > 0) {
                const badge = document.createElement('div');
                badge.className = 'item-badge';
                badge.textContent = `ğŸ“ ${item.inputImages.length}`;
                el.appendChild(badge);
            }
            
            // ä¸»å›¾ç‰‡ - ä½¿ç”¨ DOM API è®¾ç½® src
            const img = document.createElement('img');
            img.loading = 'lazy';
            img.src = item.image;  // å…³é”®ï¼šç›´æ¥èµ‹å€¼ï¼Œä¸ç”¨æ¨¡æ¿å­—ç¬¦ä¸²
            img.onerror = () => {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥, ID:', item.id);
                img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23333" width="100" height="100"/><text fill="%23666" x="50%" y="50%" text-anchor="middle" dy=".3em">Error</text></svg>';
            };
            el.appendChild(img);
            
            // æ“ä½œæŒ‰é’®
            const actions = document.createElement('div');
            actions.className = 'item-actions';

            const shareBtn = document.createElement('button');
            shareBtn.className = 'icon-btn share-btn';
            shareBtn.innerHTML = 'ğŸŒ';
            shareBtn.title = 'å‘å¸ƒåˆ°å…¬å…±ç”»å»Š';
            shareBtn.setAttribute('aria-label', 'å‘å¸ƒåˆ°å…¬å…±ç”»å»Š');
            shareBtn.onclick = (e) => {
                e.stopPropagation();
                PublicGalleryManager.share(item, shareBtn);
            };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'icon-btn';
            downloadBtn.innerHTML = 'â¬‡';
            downloadBtn.onclick = (e) => {
                e.stopPropagation();
                this.downloadImage(item);
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'icon-btn';
            deleteBtn.style.background = 'rgba(239,68,68,0.8)';
            deleteBtn.innerHTML = 'ğŸ—‘';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                this.deleteItem(item.id);
            };

            actions.appendChild(shareBtn);
            actions.appendChild(downloadBtn);
            actions.appendChild(deleteBtn);
            el.appendChild(actions);

            // ç‚¹å‡»æ‰“å¼€å¼¹çª—
            el.onclick = () => ModalManager.open(item);
            
            return el;
        },
        
        downloadImage(item) {
            const link = document.createElement('a');
            link.href = item.image;
            link.download = `banana-pro-${item.id}-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        },
        
        async deleteItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
            
            try {
                await Database.delete(id);
                await this.load();
            } catch (err) {
                console.error('åˆ é™¤å¤±è´¥:', err);
                alert('åˆ é™¤å¤±è´¥');
            }
        }
    };
    
    // ============================================
    // å¼¹çª—ç®¡ç†æ¨¡å—
    // ============================================
    const ModalManager = {
        modal: null,
        imgEl: null,
        promptEl: null,
        refsEl: null,
        reuseBtn: null,
        
        init() {
            this.modal = document.getElementById('modal');
            this.imgEl = document.getElementById('m-img');
            this.promptEl = document.getElementById('m-prompt');
            this.refsEl = document.getElementById('m-refs');
            this.reuseBtn = document.getElementById('m-reuse');
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            this.modal.onclick = (e) => {
                if (e.target === this.modal) this.close();
            };
            
            // ESC å…³é—­
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') this.close();
            });
        },
        
        open(item) {
            AppState.currentModalItem = item;
            
            // è®¾ç½®ä¸»å›¾ - ç›´æ¥èµ‹å€¼
            this.imgEl.src = item.image;
            
            // è®¾ç½®æç¤ºè¯
            this.promptEl.textContent = item.prompt;
            
            // æ¸²æŸ“å‚è€ƒå›¾
            this.refsEl.innerHTML = '';
            if (item.inputImages && item.inputImages.length > 0) {
                item.inputImages.forEach(imgData => {
                    const thumb = document.createElement('img');
                    thumb.className = 'ref-thumb';
                    thumb.src = imgData;  // ç›´æ¥èµ‹å€¼
                    thumb.onclick = () => window.open(imgData, '_blank');
                    this.refsEl.appendChild(thumb);
                });
            }
            
            // ç»‘å®šå¤ç”¨æŒ‰é’®
            this.reuseBtn.onclick = () => this.reuse();
            
            this.modal.style.display = 'flex';
        },
        
        close() {
            this.modal.style.display = 'none';
            AppState.currentModalItem = null;
        },
        
        reuse() {
            const item = AppState.currentModalItem;
            if (!item) return;
            
            // å¤ç”¨æç¤ºè¯
            const textarea = document.getElementById('prompt');
            textarea.value = item.prompt;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            
            // å¤ç”¨å‚è€ƒå›¾
            if (item.inputImages && item.inputImages.length > 0) {
                ImageHandler.setImages(item.inputImages);
            } else {
                ImageHandler.clear();
            }
            
            this.close();
            textarea.focus();
        }
    };

    // ============================================
    // å…¬å…±ç”»å»Šç®¡ç†æ¨¡å—
    // ============================================
    const PublicGalleryManager = {
        container: null,
        refreshBtn: null,
        hintEl: null,
        tokens: {},
        isLoading: false,
        defaultHint: DEFAULT_PUBLIC_HINT,
        hintTimer: null,

        init() {
            this.container = document.getElementById('public-gallery');
            this.refreshBtn = document.getElementById('refresh-public-gallery');
            this.hintEl = document.getElementById('public-gallery-hint');
            this.tokens = this.loadTokens();
            if (this.hintEl && this.hintEl.textContent) {
                this.defaultHint = this.hintEl.textContent;
            }
            this.setHint(this.defaultHint);

            if (this.refreshBtn) {
                this.refreshBtn.onclick = () => this.fetch();
            }
        },

        loadTokens() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.publicGalleryTokens);
                return raw ? JSON.parse(raw) : {};
            } catch (error) {
                console.warn('æ— æ³•è¯»å–å…¬å…±ç”»å»Šä»¤ç‰Œ:', error);
                return {};
            }
        },

        saveTokens() {
            try {
                localStorage.setItem(STORAGE_KEYS.publicGalleryTokens, JSON.stringify(this.tokens));
            } catch (error) {
                console.warn('æ— æ³•ä¿å­˜å…¬å…±ç”»å»Šä»¤ç‰Œ:', error);
            }
        },

        setHint(message, mode = 'default') {
            if (!this.hintEl) return;
            this.hintEl.textContent = message;
            this.hintEl.classList.remove('is-error', 'is-success');
            if (mode === 'error') {
                this.hintEl.classList.add('is-error');
            } else if (mode === 'success') {
                this.hintEl.classList.add('is-success');
            }
            clearTimeout(this.hintTimer);
            if (mode !== 'default') {
                this.hintTimer = setTimeout(() => {
                    this.setHint(this.defaultHint);
                }, 4000);
            }
        },

        setLoading(loading) {
            this.isLoading = loading;
            if (this.refreshBtn) {
                this.refreshBtn.classList.toggle('spinning', loading);
                this.refreshBtn.disabled = loading;
            }
        },

        async fetch() {
            if (!this.container) return;
            this.setLoading(true);
            try {
                const res = await fetch('/api/public-gallery');
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.message || 'æ— æ³•åŠ è½½å…¬å…±ç”»å»Š');
                }

                AppState.publicGalleryData = data.items || [];
                this.render();
                this.setHint(this.defaultHint);
            } catch (error) {
                console.error('å…¬å…±ç”»å»ŠåŠ è½½å¤±è´¥:', error);
                this.setHint('å…¬å…±ç”»å»ŠåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                this.showEmpty('æ— æ³•åŠ è½½å…¬å…±ç”»å»Šï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                this.setLoading(false);
            }
        },

        showEmpty(message) {
            if (!this.container) return;
            this.container.innerHTML = `
                <div class="public-gallery-empty">
                    <div>ğŸŒŒ</div>
                    <p>${message}</p>
                </div>
            `;
        },

        render() {
            if (!this.container) return;

            if (!AppState.publicGalleryData || AppState.publicGalleryData.length === 0) {
                this.showEmpty('è¿˜æ²¡æœ‰äººåˆ†äº«ä½œå“ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªå§ï¼');
                return;
            }

            this.container.innerHTML = '';
            AppState.publicGalleryData.forEach(item => {
                const card = this.createCard(item);
                this.container.appendChild(card);
            });
        },

        createCard(item) {
            const card = document.createElement('div');
            card.className = 'public-card';

            const img = document.createElement('img');
            img.loading = 'lazy';
            img.src = item.image;
            card.appendChild(img);

            const info = document.createElement('div');
            info.className = 'public-card-info';

            const promptText = document.createElement('p');
            promptText.className = 'public-card-prompt';
            promptText.textContent = item.prompt || 'æœªæä¾›æç¤ºè¯';
            info.appendChild(promptText);

            const footer = document.createElement('div');
            footer.className = 'public-card-footer';

            const timeText = document.createElement('span');
            timeText.textContent = this.formatTimestamp(item.timestamp);
            footer.appendChild(timeText);

            if (this.canDelete(item.id)) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'icon-btn small public-delete-btn';
                deleteBtn.innerHTML = 'ğŸ—‘';
                deleteBtn.title = 'åˆ é™¤è¿™å¼ ä½œå“';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.delete(item.id);
                };
                footer.appendChild(deleteBtn);
            }

            info.appendChild(footer);
            card.appendChild(info);

            card.onclick = () => ModalManager.open(item);

            return card;
        },

        formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) {
                return '';
            }
            return date.toLocaleString();
        },

        canDelete(id) {
            return Boolean(this.tokens[id]);
        },

        markOwned(id, token) {
            if (!id || !token) return;
            this.tokens[id] = token;
            this.saveTokens();
        },

        removeOwnership(id) {
            if (this.tokens[id]) {
                delete this.tokens[id];
                this.saveTokens();
            }
        },

        async share(item, triggerBtn) {
            if (!item) return;

            const confirmShare = confirm('ç¡®è®¤å°†è¿™å¼ ä½œå“å‘å¸ƒåˆ°å…¬å…±ç”»å»Šï¼Ÿæç¤ºè¯å°†å¯¹æ‰€æœ‰äººå¯è§ã€‚');
            if (!confirmShare) {
                return;
            }

            if (triggerBtn) {
                triggerBtn.disabled = true;
            }

            try {
                const res = await fetch('/api/public-gallery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: item.prompt,
                        image: item.image,
                        inputImages: item.inputImages || []
                    })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.message || 'å‘å¸ƒå¤±è´¥');
                }

                AppState.publicGalleryData = [data.item, ...(AppState.publicGalleryData || [])];
                this.markOwned(data.item.id, data.deleteToken);
                this.render();
                this.setHint('ä½œå“å·²å‘å¸ƒè‡³å…¬å…±ç”»å»Š', 'success');
            } catch (error) {
                console.error('å‘å¸ƒåˆ°å…¬å…±ç”»å»Šå¤±è´¥:', error);
                alert('å‘å¸ƒå¤±è´¥: ' + error.message);
                this.setHint('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                if (triggerBtn) {
                    triggerBtn.disabled = false;
                }
            }
        },

        async delete(id) {
            const token = this.tokens[id];
            if (!token) {
                alert('æ— æ³•è·å–åˆ é™¤å‡­è¯ï¼Œæ— æ³•åˆ é™¤è¯¥ä½œå“');
                return;
            }

            const confirmDelete = confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å…¬å…±ç”»å»Šä½œå“å—ï¼Ÿ');
            if (!confirmDelete) {
                return;
            }

            try {
                const res = await fetch(`/api/public-gallery/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deleteToken: token })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.message || 'åˆ é™¤å¤±è´¥');
                }

                AppState.publicGalleryData = AppState.publicGalleryData.filter(item => item.id !== id);
                this.removeOwnership(id);
                this.render();
                this.setHint('ä½œå“å·²åˆ é™¤', 'success');
            } catch (error) {
                console.error('åˆ é™¤å…¬å…±ç”»å»Šä½œå“å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
                this.setHint('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
            }
        }
    };

    // ============================================
    // ç”Ÿæˆè¯·æ±‚æ¨¡å—
    // ============================================
    const Generator = {
        sendBtn: null,
        textarea: null,

        init() {
            this.sendBtn = document.getElementById('send-btn');
            this.textarea = document.getElementById('prompt');

            this.sendBtn.onclick = () => this.generate();
            
            // è¾“å…¥æ¡†è‡ªåŠ¨é«˜åº¦
            this.textarea.addEventListener('input', () => {
                this.textarea.style.height = 'auto';
                this.textarea.style.height = this.textarea.scrollHeight + 'px';
            });
            
            // å›è½¦å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰
            this.textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.generate();
                }
            });
        },
        
        setLoading(loading) {
            if (loading) {
                this.sendBtn.classList.add('loading');
                this.sendBtn.disabled = true;
            } else {
                this.sendBtn.classList.remove('loading');
                this.sendBtn.disabled = false;
            }
        },
        
        async generate() {
            const prompt = this.textarea.value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }
            
            this.setLoading(true);
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        images: AppState.currentImages
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'ç”Ÿæˆå¤±è´¥');
                }
                
                // éªŒè¯è¿”å›çš„å›¾ç‰‡æ•°æ®
                if (!data.image || !data.image.startsWith('data:image')) {
                    throw new Error('è¿”å›çš„å›¾ç‰‡æ•°æ®æ— æ•ˆ');
                }
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await Database.save({
                    prompt: prompt,
                    image: data.image,
                    inputImages: [...AppState.currentImages]
                });
                
                // åˆ·æ–°ç”»å»Š
                await GalleryManager.load();
                
                // æ¸…ç©ºè¾“å…¥
                this.textarea.value = '';
                this.textarea.style.height = 'auto';
                ImageHandler.clear();
                
            } catch (err) {
                console.error('ç”Ÿæˆå¤±è´¥:', err);
                alert('ç”Ÿæˆå¤±è´¥: ' + err.message);
            } finally {
                this.setLoading(false);
            }
        }
    };
    
    // ============================================
    // è®¤è¯æ¨¡å—
    // ============================================
    const Auth = {
        async check() {
            try {
                const res = await fetch('/api/check-auth');
                const data = await res.json();
                return data.authenticated;
            } catch {
                return false;
            }
        },
        
        async login(password) {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await res.json();
            return data.success;
        },
        
        unlock() {
            document.getElementById('login-overlay').style.display = 'none';
            const app = document.getElementById('app');
            app.style.filter = 'none';
            app.style.pointerEvents = 'all';
        }
    };
    
    // ============================================
    // æ‹–æ‹½ä¸Šä¼ æ¨¡å—
    // ============================================
    const DragDrop = {
        dropZone: null,
        
        init() {
            this.dropZone = document.getElementById('drop-zone');
            
            // é˜»æ­¢é»˜è®¤è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                this.dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // æ‹–å…¥é«˜äº®
            ['dragenter', 'dragover'].forEach(event => {
                this.dropZone.addEventListener(event, () => {
                    this.dropZone.style.borderColor = 'var(--accent-color)';
                    this.dropZone.style.background = 'rgba(59, 130, 246, 0.1)';
                });
            });
            
            // æ‹–å‡ºæ¢å¤
            ['dragleave', 'drop'].forEach(event => {
                this.dropZone.addEventListener(event, () => {
                    this.dropZone.style.borderColor = '';
                    this.dropZone.style.background = '';
                });
            });
            
            // æ”¾ä¸‹å¤„ç†
            this.dropZone.addEventListener('drop', async (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    await ImageHandler.processFiles(files);
                }
            });
        }
    };
    
    // ============================================
    // æ–‡ä»¶é€‰æ‹©æ¨¡å—
    // ============================================
    const FileSelector = {
        input: null,
        btn: null,
        
        init() {
            this.input = document.getElementById('file-input');
            this.btn = document.getElementById('upload-btn');
            
            this.btn.onclick = () => this.input.click();
            
            this.input.onchange = async () => {
                if (this.input.files.length > 0) {
                    await ImageHandler.processFiles(this.input.files);
                }
                this.input.value = ''; // é‡ç½®ä»¥ä¾¿é‡å¤é€‰æ‹©
            };
        }
    };
    
    // ============================================
    // å…¨å±€å‡½æ•°ï¼ˆä¾› HTML onclick è°ƒç”¨ï¼‰
    // ============================================
    async function loadWorkspaceData() {
        try {
            await Promise.all([
                GalleryManager.load(),
                PublicGalleryManager.fetch()
            ]);
        } catch (error) {
            console.error('åŠ è½½ç”»å»Šæ•°æ®å¤±è´¥:', error);
        }
    }

    async function doLogin() {
        const pwd = document.getElementById('pwd').value;
        if (!pwd) return;

        const success = await Auth.login(pwd);
        if (success) {
            Auth.unlock();
            await loadWorkspaceData();
        } else {
            alert('å¯†ç é”™è¯¯');
        }
    }

    function closeModal() {
        ModalManager.close();
    }
    
    // ============================================
    // åº”ç”¨åˆå§‹åŒ–
    // ============================================
    async function initApp() {
        try {
            // åˆå§‹åŒ–æ•°æ®åº“
            await Database.init();
            
            // åˆå§‹åŒ–å„æ¨¡å—
            PreviewManager.init();
            GalleryManager.init();
            ModalManager.init();
            PublicGalleryManager.init();
            Generator.init();
            DragDrop.init();
            FileSelector.init();

            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            const isAuth = await Auth.check();
            if (isAuth) {
                Auth.unlock();
                await loadWorkspaceData();
            }

            console.log('App initialized successfully');
        } catch (err) {
            console.error('App initialization failed:', err);
        }
    }
    
    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>